name: Process Detection Rule Request

on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  extract-and-process:
    if: contains(github.event.issue.labels.*.name, 'detection-rule')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract issue form data
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // Function to extract form field value
            function extractField(body, fieldLabel) {
              const regex = new RegExp(`### ${fieldLabel}\\s*\\n+([\\s\\S]*?)(?=\\n###|$)`, 'i');
              const match = body.match(regex);
              if (match && match[1]) {
                const value = match[1].trim();
                return value === '_No response_' || value === '' ? null : value;
              }
              return null;
            }
            
            // Function to extract array fields (split by newlines)
            function extractArrayField(body, fieldLabel) {
              const value = extractField(body, fieldLabel);
              if (!value) return [];
              // Remove code block markers (```text, ```, etc.) and split by newlines
              const cleanValue = value.replace(/```\w*\n?/g, '').replace(/```/g, '');
              return cleanValue.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            }
            
            // Extract all fields
            const data = {
              ruleName: extractField(issueBody, 'Rule Name'),
              ruleStatus: extractField(issueBody, 'Rule Status'),
              ruleDescription: extractField(issueBody, 'Rule Description'),
              references: extractArrayField(issueBody, 'References'),
              authorBy: extractField(issueBody, 'Author By'),
              authorDate: extractField(issueBody, 'Author Date'),
              modifiedBy: extractField(issueBody, 'Modified By'),
              modifiedDate: extractField(issueBody, 'Modified Date'),
              tags: extractArrayField(issueBody, 'MITRE ATT&CK Mapping'),
              logSourceVendor: extractField(issueBody, 'Vendor Data Sources'),
              logSourceService: extractField(issueBody, 'Service Data Sources'),
              detectionQueryBefore: extractField(issueBody, 'Detection Query Before'),
              detectionQueryAfter: extractField(issueBody, 'Detection Query After'),
              detectionQueryCondition: extractField(issueBody, 'Detection Query Condition'),
              detectionQuerySuppress: extractField(issueBody, 'Detection Query Suppress'),
              severity: extractField(issueBody, 'Severity'),
              outcome: extractField(issueBody, 'Outcome'),
              reviewLastReviewed: extractField(issueBody, 'Review Last Reviewed'),
              reviewNextReview: extractField(issueBody, 'Review Next Review'),
              expiryDate: extractField(issueBody, 'Expiry Date')
            };
            
            // Log extracted data
            console.log('Extracted Detection Rule Data:');
            console.log(JSON.stringify(data, null, 2));
            
            // Set output for use in next steps
            core.setOutput('rule-data', JSON.stringify(data));
            core.setOutput('rule-name', data.ruleName || 'unknown');
            
            return data;

      - name: Create detection rule file
        env:
          RULE_DATA: ${{ steps.extract.outputs.rule-data }}
        run: |
          # Install yq for YAML generation
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
          
          # Parse the JSON data
          echo "$RULE_DATA" | jq .
          
          # Create SIEM directory if it doesn't exist
          mkdir -p SIEM/Rules
          
          # Extract rule name and sanitize for filename
          RULE_NAME=$(echo "$RULE_DATA" | jq -r '.ruleName // "unknown-rule"' | tr ' ' '-' | tr '[:upper:]' '[:lower:]' | sed 's/[^a-z0-9-]//g')
          
          # Create proper YAML file using yq
          echo "$RULE_DATA" | jq '{
            name: .ruleName,
            status: .ruleStatus,
            description: .ruleDescription,
            references: (if .references | length > 0 then .references else null end),
            author: {
              by: .authorBy,
              date: .authorDate
            },
            modified: {
              by: (.modifiedBy // null),
              date: (.modifiedDate // null)
            },
            tags: (if .tags | length > 0 then .tags else null end),
            log_source: {
              vendor: .logSourceVendor,
              service: .logSourceService
            },
            detection: {
              query: {
                before: .detectionQueryBefore,
                after: .detectionQueryAfter
              },
              condition: .detectionQueryCondition,
              suppress: (.detectionQuerySuppress // null)
            },
            severity: .severity,
            outcome: .outcome,
            review: {
              last_reviewed: .reviewLastReviewed,
              next_review: .reviewNextReview
            },
            expiry_date: (.expiryDate // null)
          }' | yq -P > "SIEM/Rules/${RULE_NAME}.yml"
          
          echo "Created rule file: SIEM/Rules/${RULE_NAME}.yml"
          echo ""
          echo "Generated YAML content:"
          cat "SIEM/Rules/${RULE_NAME}.yml"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add detection rule: ${{ steps.extract.outputs.rule-name }}"
          title: "Detection Rule: ${{ steps.extract.outputs.rule-name }}"
          body: |
            This PR adds a new detection rule based on issue #${{ github.event.issue.number }}
            
            **Rule Name:** ${{ steps.extract.outputs.rule-name }}
            
            Closes #${{ github.event.issue.number }}
          branch: detection-rule-${{ github.event.issue.number }}
          delete-branch: true
          labels: detection-rule

      - name: Comment on issue
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âœ… Detection rule data has been extracted and a pull request has been created. Please review the PR to approve the new rule.'
            })
